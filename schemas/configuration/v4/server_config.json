{
    "$id": "https://irods.org/schemas/server_config",
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "type": "object",
    "properties": {
        "ips_data_directory": {"type": "string"},
        "stacktrace_directory": {"type": "string"},
        "json_schema_file": {"type": "string"},

        "advanced_settings": {
            "type": "object",
            "properties": {
                "agent_factory_watcher_sleep_time_in_seconds": {"type": "integer"},
                "default_number_of_transfer_threads": {"type": "integer"},
                "default_temporary_password_lifetime_in_seconds": {"type": "integer"},
                "delay_rule_executors": {
                    "type": "array",
                    "items": {"type": "string"},
                    "uniqueItems": true
                },
                "delay_server_sleep_time_in_seconds": {"type": "integer"},
                "dns_cache": {
                    "type": "object",
                    "properties": {
                        "shared_memory_size_in_bytes": {"type": "integer"},
                        "eviction_age_in_seconds": {"type": "integer"},
                        "cache_clearer_sleep_time_in_seconds": {"type": "integer"}
                    }
                },
                "hostname_cache": {
                    "type": "object",
                    "properties": {
                        "shared_memory_size_in_bytes": {"type": "integer"},
                        "eviction_age_in_seconds": {"type": "integer"},
                        "cache_clearer_sleep_time_in_seconds": {"type": "integer"}
                    }
                },
                "maximum_size_for_single_buffer_in_megabytes": {"type": "integer"},
                "maximum_size_of_delay_queue_in_bytes": {"type": "integer"},
                "maximum_temporary_password_lifetime_in_seconds": {"type": "integer"},
                "migrate_delay_server_sleep_time_in_seconds":  {"type": "integer"},
                "number_of_concurrent_delay_rule_executors": {"type": "integer"},
                "stacktrace_file_processor_sleep_time_in_seconds": {"type": "integer"},
                "transfer_buffer_size_for_parallel_transfer_in_megabytes": {"type": "integer"},
                "transfer_chunk_size_for_parallel_transfer_in_megabytes": {"type": "integer"}
            },
            "required": [
                "default_number_of_transfer_threads",
                "default_temporary_password_lifetime_in_seconds",
                "maximum_size_for_single_buffer_in_megabytes",
                "maximum_temporary_password_lifetime_in_seconds",
                "transfer_buffer_size_for_parallel_transfer_in_megabytes",
                "transfer_chunk_size_for_parallel_transfer_in_megabytes"
            ]
        },
        "catalog_provider_hosts": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 1,
            "uniqueItems": true
        },
        "catalog_service_role": {"enum": ["consumer","provider"]},
        "client_api_allowlist_policy": {"enum": ["disabled", "enforce"]},
        "controlled_user_connection_list": {
            "type": "object",
            "properties": {
                "control_type": {"enum": ["denylist", "allowlist"]},
                "users": {
                    "type": "array",
                    "items": {"type": "string"},
                    "uniqueItems": true
                }
            }
        },
        "maximum_connections": {
            "type": "integer",
            "minimum": 1
        },
        "default_dir_mode": {"type": "string"},
        "default_file_mode": {"type": "string"},
        "default_hash_scheme": {"type": "string"},
        "environment_variables": {
            "type": "object",
            "additionalProperties": {"type": "string"}
        },
        "federation": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "catalog_provider_hosts": {
                        "type": "array",
                        "items": {"type": "string"},
                        "minItems": 1,
                        "uniqueItems": true
                    },
                    "negotiation_key": {"type": "string", "pattern": "^[A-Za-z0-9_]+$", "minLength": 32, "maxLength": 32},
                    "zone_key": {"type": "string", "pattern": "^[A-Za-z0-9_]+$", "maxLength": 49},
                    "zone_name": {"type": "string", "pattern": "^[A-Za-z0-9_\\.]+$", "maxLength": 63},
                    "zone_port": {"type": "integer"}
                },
                "required": ["catalog_provider_hosts","negotiation_key","zone_key","zone_name"]
            }
        },
        "host_access_control": {
            "$id": "https://irods.org/schemas/host_access_control",
            "$schema": "https://json-schema.org/draft/2020-12/schema",
            "type": "object",
            "properties": {
                "access_entries": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "user": {"type": "string"},
                            "group": {"type": "string"},
                            "address": {"type": "string"},
                            "mask": {"type": "string"}
                        },
                        "required": ["user","group","address","mask"]
                    }
                }
            },
            "required": ["access_entries"]
        },
        "host_resolution": {
            "$id": "https://irods.org/schemas/host_resolution",
            "$schema": "https://json-schema.org/draft/2020-12/schema",
            "type": "object",
            "properties": {
                "host_entries": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "address_type": {"enum": ["local","remote"]},
                            "addresses": {
                                "type": "array",
                                "items": {
                                    "type": "string",
                                    "minLength": 1
                                },
                                "uniqueItems": true,
                                "minItems": 2
                            }
                        },
                        "required": ["address_type","addresses"]
                    }
                }
            },
            "required": ["host_entries"]
        },
        "log_level": {
            "type": "object",
            "items": {
                "properties": {
                    "agent": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "agent_factory": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "api": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "authentication": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "database": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "delay_server": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "legacy": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "microservice": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "network": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "resource": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "rule_engine": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1},
                    "server": {"enum": ["trace", "debug", "info", "warn", "error", "critical"], "maxItems": 1}
                }
            }
        },
        "match_hash_policy": {"type": "string"},
        "negotiation_key": {"type": "string", "pattern": "^[A-Za-z0-9_]+$", "minLength": 32, "maxLength": 32},
        "plugin_configuration": {
            "type": "object",
            "properties": {
                "authentication": {
                    "type": "object",
                    "properties": {}
                },
                "database": {
                    "type": "object",
                    "patternProperties": {
                        "^[^\\s]+$": {
                            "$id": "https://irods.org/schemas/database_config",
                            "$schema": "https://json-schema.org/draft/2020-12/schema",
                            "type": "object",
                            "properties": {
                                "db_host": {"type": "string"},
                                "db_name": {"type": "string"},
                                "db_odbc_driver": {"type": "string"},
                                "db_password": {"type": "string"},
                                "db_port": {"type": "integer"},
                                "db_username": {"type": "string"},
                                "db_sslmode": {"type": "string"},
                                "db_sslrootcert": {"type": "string"},
                                "db_sslcert": {"type": "string"},
                                "db_sslkey": {"type": "string"}
                            },
                            "required": [
                                "db_host",
                                "db_name",
                                "db_password",
                                "db_port",
                                "db_username"
                            ]
                        }
                    },
                    "maxProperties": 1,
                    "minProperties": 1
                },
                "network": {
                    "type": "object",
                    "properties": {}
                },
                "resource": {
                    "type": "object",
                    "properties": {}
                },
                "rule_engines": {
                    "type": "array",
                    "items": {
                        "$id": "https://irods.org/schemas/rule_engine",
                        "$schema": "https://json-schema.org/draft/2020-12/schema",
                        "type": "object",
                        "properties": {
                            "instance_name": {"type": "string", "minLength": 1},
                            "plugin_name": {"type": "string", "minLength": 1},
                            "plugin_specific_configuration": {
                                "type": "object",
                                "properties": {}
                            },
                            "shared_memory_instance": {"type": "string"}
                        },
                        "required": [
                            "instance_name",
                            "plugin_name",
                            "plugin_specific_configuration"
                        ]
                    },
                    "minItems": 1
                }
            },
            "required": ["authentication","network","resource","rule_engines"]
        },
        "schema_name": {"type": "string"},
        "schema_validation_base_uri": {"type": "string"},
        "schema_version": {"type": "string"},
        "server_control_plane_encryption_algorithm": {"type": "string"},
        "server_control_plane_encryption_num_hash_rounds": {"type": "integer"},
        "server_control_plane_key": {"type": "string", "minLength": 32, "maxLength": 32},
        "server_control_plane_port": {"type": "integer"},
        "server_control_plane_timeout_milliseconds": {"type": "integer"},
        "server_port_range_end": {"type": "integer"},
        "server_port_range_start": {"type": "integer"},
        "zone_auth_scheme" : {"type": "string"},
        "zone_key": {"type": "string", "pattern": "^[A-Za-z0-9_]+$", "maxLength": 49},
        "zone_name": {"type": "string", "pattern": "^[A-Za-z0-9_\\.]+$", "maxLength": 63},
        "zone_port": {"type": "integer"},
        "zone_user": {"type": "string"}
    },
    "required": [
        "ips_data_directory",
        "stacktrace_directory",
        "json_schema_file",
        "advanced_settings",
        "catalog_provider_hosts",
        "catalog_service_role",
        "client_api_allowlist_policy",
        "controlled_user_connection_list",
        "default_dir_mode",
        "default_file_mode",
        "default_hash_scheme",
        "environment_variables",
        "federation",
        "host_access_control",
        "host_resolution",
        "log_level",
        "match_hash_policy",
        "negotiation_key",
        "plugin_configuration",
        "rule_engine_namespaces",
        "schema_name",
        "schema_validation_base_uri",
        "schema_version",
        "server_control_plane_encryption_algorithm",
        "server_control_plane_encryption_num_hash_rounds",
        "server_control_plane_key",
        "server_control_plane_port",
        "server_control_plane_timeout_milliseconds",
        "server_port_range_end",
        "server_port_range_start",
        "zone_auth_scheme",
        "zone_key",
        "zone_name",
        "zone_port",
        "zone_user"
    ]
}
